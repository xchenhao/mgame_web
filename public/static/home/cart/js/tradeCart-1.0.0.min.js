$(function () {
    function tradeCart() {
        $("input[type=checkbox]").attr("checked", "checked"), $(".check_goods").each(function () {
            $(this).attr("checked") ? ($(this).parents("tr").find("td").css("background-color", "#FFFFFF"), $(this).parents("tr").next(".bx-list-box").find("td").css("background-color", "#FFFFFF")) : ($(this).parents("tr").find("td").css("background-color", "#FFF7E8"), $(this).parents("tr").next(".bx-list-box").find("td").css("background-color", "#FFF7E8"))
        }), $(".total-pay").click(function () {
            var _isLogin = OKHQB_sign.isSignIn(), _xuan = $(".check_goods:checked");
            if (0 == _xuan.length)return art.dialog({
                title: "提示",
                content: "请选择要结算的商品！",
                time: 3,
                icon: "warning",
                drag: !1
            }), !1;
            if (!_isLogin) {
                var __callback = function () {
                    $.ajax({
                        url: "http://login.okhqb.com/member/getLoginInfo.json?callback=?",
                        data: {},
                        type: "GET",
                        dataType: "jsonp",
                        jsonpCallback: "callback",
                        success: function (d) {
                            var _result = eval("(" + d.data + ")");
                            5 == _result.member_type ? window.location.href = window.location.href : $("#__cartForm").submit()
                        }
                    })
                };
                return OKHQB_sign.dialog({sign_in_callback: __callback}), !1
            }
            $("#__cartForm").submit()
        }), $(".zp-p-span").hover(function () {
            var t = $(this).find(".triangle").length;
            t || $(this).siblings(".zp-lists").show()
        }, function () {
            var t = $(this).find(".triangle").length;
            t || $(this).siblings(".zp-lists").hide()
        }), delSinge(), numChange(), timeDown($(".cart-time")), gather(), listSlider($(".change-slider-list ul"), $(".change-slider-left"), $(".change-slider-right")), historyOrder(), buyBtnFix(), goodsBuy(), showStateTips()
    }

    function goodsBuy() {
        $(".change-buy,.sp-slider-buy").click(function () {
            var t = $(this).data("skuid");
            jionCart(t)
        })
    }

    function jionCart(t) {
        $.ajax({
            type: "GET",
            url: "http://buy.okhqb.com/buy/addCart.json?skuId=" + t + "&quantity=1",
            dataType: "jsonp",
            jsonp: "callback",
            success: function (t) {
                200 === t.code ? window.location.reload() : artDialog({
                    id: "jionError",
                    title: "温馨提示",
                    content: t.msg,
                    time: 2
                })
            }
        })
    }

    function buyBtnFix() {
        if ($(".total-sec-bottom").length <= 0)return !1;
        var t = $(window).height(), i = $(window).scrollTop(), e = $(".total-sec-bottom"), a = e.offset().top,
            s = e.outerHeight();
        t + i - s > a ? e.removeClass("total-bottom-fixed") : e.addClass("total-bottom-fixed"), $(window).scroll(function () {
            t + $(this).scrollTop() - s > a ? e.removeClass("total-bottom-fixed") : e.addClass("total-bottom-fixed")
        })
    }

    function timeDown(t) {
        var i = $("#cart-times").val();
        t.timer = null, t.timer = setInterval(function () {
            if (0 >= i)return t.html(), t.find("span").html("已超时，请尽快结算"), clearInterval(t.timer), !1;
            i--;
            var e = parseInt(i / 60), a = parseInt(i % 60);
            e = e > 9 ? e : "0" + e, a = a > 9 ? a : "0" + a, t.find("span").html("商品库存有限，请在<i>" + e + "分" + a + "秒</i>内提交订单")
        }, 1e3)
    }

    function delSinge() {
        $(".td-del").click(function () {
            $(".del_tips").hide(), $(this).next(".del_tips").stop().attr("show", "true").show().css({
                top: "100px",
                opacity: "0"
            }).animate({top: "70px", opacity: "1"}, 200)
        }), $(".can_del").click(function () {
            $(this).parents(".del_tips").removeAttr("show").animate({top: "100px", opacity: "0"}, 100).fadeOut(200)
        }), $(".ok_del").click(function () {
            var t = $(this).parents("tr"), i = $(this).attr("data"), e = $(this).parents("table");
            $(this).parents(".del_tips").removeAttr("show").hide(), $.ajax({
                type: "GET",
                url: "http://buy.okhqb.com/cart/delete.json?status=T&cartIds=" + i,
                dataType: "jsonp",
                jsonpCallback: "callback",
                success: function (i) {
                    if (200 == i.code) {
                        if (t.attr("id") && $("." + t.attr("id")).remove(), t.remove(), $(".cart-list,.no-order-table").each(function () {
                                0 == $(this).find("tr").length && $(this).remove()
                            }), $(".mj-section").each(function () {
                                var t = $(this), i = t.prev(".title-tips");
                                0 == t.find(".check_goods").length && (i.remove(), t.remove())
                            }), 1 == $(".no-order-list").find("table").length && $(".no-order-list").remove(), 0 == $(".check_goods").length)return void location.reload();
                        e.hasClass("mj-order-table") && mjrule(), renderView()
                    } else art.dialog({
                        id: "008",
                        title: "提示",
                        content: '<div style="padding:0 30px;">' + i.msg + "</div>"
                    })
                }
            })
        })
    }

    function numChange() {
        $(".check_goods").click(function () {
            $(this).attr("checked") ? ($(this).parents("tr").find("td").css("background-color", "#FFFFFF"), $(this).parents("tr").next(".bx-list-box").find("td").css("background-color", "#FFFFFF")) : ($(this).parents("tr").find("td").css("background-color", "#FFF7E8"), $(this).parents("tr").next(".bx-list-box").find("td").css("background-color", "#FFF7E8")), $(this).parents("table").hasClass("mj-order-table") && mjrule(), renderView()
        }),
        $(".plus").click(function () {
            var t = $(this), i = $(this).parents("tr").find(".check_goods").val();
            $cartCk = $(this).parents("tr").find(".check_goods").attr("checked"), $quantity = Number($(this).siblings(".counts").val()), counts(t, $quantity, i, "p")
        }),
         $(".minus").click(function () {
            var t = $(this), i = $(this).parents("tr").find(".check_goods").val();
            return $cartCk = $(this).parents("tr").find(".check_goods").attr("checked"), $quantity = Number($(this).siblings(".counts").val()), $quantity <= 1 ? !1 : void counts(t, $quantity, i, "m")
        })
    }

    function counts(t, i, e, a) {
        "m" == a ? Number(i) >= 2 && i-- : i++, i >= 999 ? _showTips("数量过大", t) : $.ajax({
            type: "GET",
            url: "http://buy.okhqb.com/cart/quantity.json",
            dataType: "jsonp",
            data: {quantity: i, cartId: e},
            jsonpCallback: "callback",
            success: function (e) {
                if (200 == e.code) {
                    var a, s = t.parents("tr"), n = s.attr("id"), o = s.find(".check_goods").attr("checked"),
                        l = s.find(".td-price").html(), r = t.parents("table"), d = 0;
                    if (s.find(".zp-lists li").length > 0 && (a = s.find(".zp-lists li"), a.each(function () {
                            var t = $(this);
                            d = t.attr("data-num"), t.find("i").html(i * d)
                        })), t.siblings(".counts").val(i), s.find(".td-total").html((Number(l) * i).toFixed(2)), $("." + n).each(function () {
                            var t = $(this), e = t.find(".bx-dj i").html(), a = Number(e) * i;
                            t.find(".bx-sl").html(i), t.find(".bx-total b").html(a.toFixed(2))
                        }), r.hasClass("mj-order-table") && mjrule(), !o)return !1;
                    renderView()
                } else if (21006 == e.code) _showTips("库存紧张", t); else {
                    if (90004 !== e.code)return _showTips(e.msg, t), !1;
                    _showTips("限购" + e.data + "件", t)
                }
            }
        })
    }

    function renderView() {
        getSum()
    }

    function getSum() {
        var t = 0, i = 0, e = 0, a = $(".total-yf").html(), s = ($(".total-count"), 0);
        if ($(".mj-total").each(function () {
                s += Number($(this).html())
            }), $(".count").each(function () {
                var e = $(this), a = Number(e.val()), s = e.parents("tr").find(".td-price").html();
                e.parents("tr").find(".check_goods").attr("checked") && s && (t += a * Number(s), i += e.attr("data-counts") ? a * e.attr("data-counts") : a)
            }), $(".bx-list-box").each(function () {
                var i = $(this), e = i.attr("data-goods"), a = $("#" + e).find(".check_goods").attr("checked");
                if (a) {
                    var s = Number(i.find(".bx-total b").html());
                    t += s
                }
            }), t -= s, $(".total-count").html(i), Number(t) <= 0)return $(".total-sum").html("00.00"), $(".total-yf").html(0), $(".by-tips").html('还差<em class="need-more">79</em>元即可享受满79元包邮服务，<a class="cd-btn" href="javascript:void(0);">去凑单>></a>'), $(".total-fenqi-p").hide(), !1;
        if (e = Number(t) - 79, e >= 0 ? ($(".by-tips").html("本单已免运费"), a = 0) : (a = 79 - Number(t), $(".by-tips").html('还差<em class="need-more">' + a.toFixed(2) + '</em>元即可享受满79元包邮服务，<a class="cd-btn" href="javascript:void(0);">去凑单>></a>'), a = 6), t = Number(t) + Number(a), $(".total-yf").html(a), $(".total-sum").html(t.toFixed(2)), t - 600 >= 0) {
            var n = 1.09 * t / 18;
            if ($(".total-fenqi-p").length > 0) $(".total-fenqi-p").html('分期付款最低<b class="total-fenqi">' + n.toFixed(0) + ".00</b>/月").show(); else {
                var o = '<p class="total-fenqi-p">分期付款最低<b class="total-fenqi">' + n.toFixed(0) + ".00</b>/月</p>";
                $(".total-sec-top-right").prepend(o)
            }
        } else $(".total-fenqi-p").hide()
    }

    function showStateTips() {
        $(".zp-p-span,.tm-icon").hover(function () {
            var t = $(this).find(".triangle");
            t.length && (t.show(), $(this).siblings(".goodsStateTip").show())
        }, function () {
            var t = $(this).find(".triangle");
            t.length && (t.hide(), $(this).siblings(".goodsStateTip").hide())
        })
    }

    function mjrule() {
        $(".mj-section").each(function () {
            var t, i, e = 0, a = $(".title-tips"), s = a.find("a").attr("href"), n = "", o = $(this), l = 0;
            if (o.find(".check_goods").each(function () {
                    var t = $(this), i = t.parents("tr");
                    t.is(":checked") && (e += Number(i.find(".td-total").html()), l += Number(i.find(".count").val()))
                }), a = o.prev(".title-tips"), s = a.find("a").attr("href"), t = a.data("rule").split(","), o.hasClass("more-sales")) {
                var r = 0;
                e = 0 == e ? o.find(".td-total").html() : e;
                for (var d = 0; d < t.length; d++) {
                    if (t[d] = t[d].split(":"), i = t[d + 1] ? t[d + 1].split(":") : 0, l < t[d][0]) {
                        r = (e * (10 - t[d][1]) * .1).toFixed(2), n = "<i>多件多折</i>再买" + Number(t[d][0] - l) + "件总价打" + t[d][1] + '折<a target="_blank" href="' + s + '">去看看&gt;&gt;</a>', a.html(n);
                        break
                    }
                    if (i && i[0] > l) {
                        r = (e * (10 - t[d][1]) * .1).toFixed(2), n = "<i>多件多折</i>已打" + t[d][1] + '折优惠<span class="mj-total">' + r + "</span>元，再买" + Number(i[0] - l) + "件总价打" + i[1] + '折<a target="_blank" href="' + s + '">去看看&gt;&gt;</a>', a.html(n);
                        break
                    }
                    if (!(i && i[0] < l) && !i && l >= t[d][0]) {
                        r = (e * (10 - t[d][1]) * .1).toFixed(2), n = "<i>多件多折</i>已打" + t[d][1] + '折优惠<span class="mj-total">' + r + '</span>元<a target="_blank" href="' + s + '">去看看&gt;&gt;</a>', a.html(n);
                        break
                    }
                }
                return !1
            }
            if (0 === e) n = "<i>满减</i>再买" + t[0].split(":")[0] + "元,可立减" + t[0].split(":")[1] + '元<a target="_blank" href="' + s + '">去看看&gt;&gt;</a>', a.html(n); else if (1 === t.length) t = t[0].split(":"), e < t[0] ? (n = "<i>满减</i>再买" + Number(t[0] - e).toFixed(2) + "元,可立减" + t[1] + '元<a target="_blank" href="' + s + '">去看看&gt;&gt;</a>', a.html(n)) : ($mj = t[1], n = '<i>满减</i>已减<span class="mj-total">' + t[1] + '</span>元<a target="_blank" href="' + s + '">去看看&gt;&gt;</a>', a.html(n)); else for (var d = 0; d < t.length; d++) {
                if (t[d] = t[d].split(":"), i = t[d + 1] ? t[d + 1].split(":") : 0, e < t[d][0]) {
                    n = "<i>满减</i>再买" + Number(t[d][0] - e).toFixed(2) + "元,可立减" + t[d][1] + '元<a target="_blank" href="' + s + '">去看看&gt;&gt;</a>', a.html(n);
                    break
                }
                if (i && i[0] > e) {
                    n = '<i>满减</i>已减<span class="mj-total">' + t[d][1] + "</span>元,再买" + Number(i[0] - e).toFixed(2) + "元,可立减" + i[1] + '元<a target="_blank" href="' + s + '">去看看&gt;&gt;</a>', a.html(n);
                    break
                }
                if (!(i && i[0] < e) && !i && e >= t[d][0]) {
                    n = '<i>满减</i>已减<span class="mj-total">' + t[d][1] + '</span>元<a target="_blank" href="' + s + '">去看看&gt;&gt;</a>', a.html(n);
                    break
                }
            }
        })
    }

    function gather() {
        $(".cd-btn").live("click", function () {
            if ($(".cd-order").length > 0) $(".cd-order").show(); else {
                var t = $(window).height(), i = $(window).width(), e = '<div class="cd-order" style="display:block;">';
                e += '<div class="cd-order-mask"></div>', e += '<div class="cd-order-content" style="top:' + (t - 460) / 2 + "px;left:" + (i - 900) / 2 + 'px;">', e += '<div class="cd-order-nav">', e += "<h3>凑单商品</h3>", e += "<ul>", e += '<li class="cd-nav-li" data-type="" data-send="0">全部</li>', e += '<li class="cd-nav-li cd-nav-on" data-type="NINE_POINT_NINE">9.9元封顶</li>', e += '<li class="cd-nav-li" data-type="NINETEEN_POINT_NINE">19.9元封顶</li>', e += '<li class="cd-nav-li" data-type="TWENTY_NINE_POINT_NINE">29.9元封顶</li>', e += '<li class="cd-nav-li" data-type="THIRTY_NINE_POINT_NINE">39.9元封顶</li>', e += '<li class="cd-nav-li" data-type="MORE_THEN_THIRTY_NINE_POINT_NINE"> >39.9元</li>', e += "</ul>", e += '<a href="javascript:void(0);" class="cd-order-close"></a>', e += "</div>", e += '<div class="cd-order-list">', e += '<span class="cd-slider-btn cd-slider-left"></span>', e += '<span class="cd-slider-btn cd-slider-right"></span>', e += '<div class="cd-order-slider"><ul class="cd-order-con-list">正在加载数据</ul></div>', e += "</div>", e += "</div>", $(".cart-main").append(e)
            }
            renderCdList(1, 36, "NINE_POINT_NINE")
        }), $(".cd-order-close").live("click", function () {
            $(".cd-order").hide(), $(".cd-order").data("newGoods") && window.location.reload()
        }), $(".cd-nav-li").live("click", function () {
            $(".cd-nav-li").removeClass("cd-nav-on"), $(this).addClass("cd-nav-on"), $(".cd-slider-left").hide(), $(".cd-slider-right").show(), $(".cd-order-con-list").css("left", 0), renderCdList(1, 36, $(this).attr("data-type"))
        }), $(".cd-order-buy").live("click", function () {
            var t = $(this).attr("data-skuid"), i = $(this).siblings(".cd-order-price").find("b").html();
            cdJionCart(t, i)
        })
    }

    function cdJionCart(t, i) {
        $.ajax({
            type: "GET",
            url: "http://buy.okhqb.com/buy/addCart.json?skuId=" + t + "&quantity=1&from=coudan",
            dataType: "jsonp",
            jsonp: "callback",
            success: function (t) {
                if (200 === t.code) {
                    var e = $(".total-sum").html(), a = $(".total-count").html();
                    $(".total-yf").html(), $(".by-tips");
                    e = Number(e) + Number(i), a = Number(a) + 1, e >= 79 ? ($(".total-yf").html(0), $(".by-tips").html("本单已免运费")) : ($(".total-yf").html(6), $(".need-more").html(79 - e)), $(".total-sum").html(e.toFixed(2)), $(".total-count").html(a), $(".cd-order").data("newGoods", 1), artDialog({
                        title: "温馨提示",
                        id: "add_success",
                        content: '<b style="color:#FF0000;">已成功添加到购物车，刷新下页面看看吧</b>',
                        icon: "succeed",
                        time: 3
                    })
                } else artDialog({title: "温馨提示", id: "add_err", content: t.msg, icon: "succeed", time: 3})
            }
        })
    }

    function cdSlider() {
        var t = $(".cd-slider-left"), i = $(".cd-slider-right"), e = $(".cd-order-con-list"), a = e.find("li").length,
            s = 0;
        t.die("click"), i.die("click"), i.show(), t.live("click", function () {
            return s--, i.show(), 0 == s ? ($(this).hide(), e.stop().animate({left: "-" + 800 * s + "px"}, 1e3), !1) : void e.stop().animate({left: "-" + 800 * s + "px"}, 1e3)
        }), i.live("click", function () {
            return s++, t.show(), s >= a - 1 ? ($(this).hide(), e.stop().animate({left: "-" + 800 * s + "px"}, 1e3), !1) : void e.stop().animate({left: "-" + 800 * s + "px"}, 1e3)
        })
    }

    function renderCdList(t, i, e) {
        $.ajax({
            url: "http://canvas.okhqb.com/ninePurchase/purchaseSkuData.json",
            data: {pageNo: t, pageSize: i, type: e},
            dataType: "jsonp",
            type: "GET",
            jsonp: "callback",
            success: function (t) {
                if (200 === t.code) {
                    for (var i = t.data, e = Math.ceil(i.length / 9), a = "", s = 0; e > s; s++) {
                        a += "<li>";
                        for (var n = 9 * s; 9 * s + 9 > n; n++)i[n] && (a += '<div class="cd-order-item" data-id="' + n + '">', a += '<a target="_blank" href="http://www.okhqb.com/item/' + i[n].skuId + '.html" class="cd-order-pic">', a += '<img class="thumb" width="100" height="100" title="' + i[n].skuTitle + '" src="' + i[n].img + '">', a += "</a>", a += '<p class="cd-order-tit"><a href="http://www.okhqb.com/item/' + i[n].skuId + '.html" target="_blank">' + i[n].skuTitle + "</a></p>", a += '<p class="cd-order-price">&yen;<b>' + i[n].price + "</b></p>", a += '<a href="javascript:void(0);" class="cd-order-buy" data-skuid="' + i[n].skuId + '">加入购物车</a>', a += "</div>");
                        a += "</li>"
                    }
                    $(".cd-order-con-list").width(800 * e), $(".cd-order-con-list").html(a), cdSlider()
                }
            }
        })
    }

    function historyOrder() {
        var t = $(".sp-title-btn"), i = $(".sp-title-on");
        return $(".sp-history-" + i.data("id")).show(), listSlider($(".sp-slider-del"), $(".sp-left-del"), $(".sp-right-del")), listSlider($(".sp-slider-look"), $(".sp-left-look"), $(".sp-right-look")), 1 == t.length ? !1 : void t.click(function () {
            var i = $(this).data("id"), e = $(".sp-history-" + i);
            t.removeClass("sp-title-on"), $(this).addClass("sp-title-on"), $(".sp-history-slider").hide(), e.show()
        })
    }

    function listSlider(t, i, e) {
        var a = i, s = e, n = t.find("li");
        return t.index = 0, t.width(n.length * n.outerWidth()), n.length > 1 ? (s.show(), a.click(function () {
            return t.index--, s.show(), 0 == t.index ? ($(this).hide(), s.show(), t.stop().animate({left: "-" + t.index * n.outerWidth() + "px"}, 1e3), !1) : void t.stop().animate({left: "-" + t.index * n.outerWidth() + "px"}, 1e3)
        }), void s.click(function () {
            return t.index++, a.show(), t.index >= n.length - 1 ? ($(this).hide(), t.stop().animate({left: "-" + t.index * n.outerWidth() + "px"}, 1e3), !1) : void t.stop().animate({left: "-" + t.index * n.outerWidth() + "px"}, 1e3)
        })) : !1
    }

    function _showTips(t, i, e) {
        var a = i.parents(".plus_minus"), s = a.find(".re_tips"), n = a.find(".cou_btn"), o = a.find(".count");
        e = 1e3 * e || 3200, s.is(":visible") ? s.animate({opacity: "0.2"}, 100).animate({opacity: "1"}, 100).animate({opacity: "0.2"}, 50).animate({opacity: "1"}, 50) : (n.css({border: "1px solid #fd2b4d"}), o.css({border: "1px solid #fd2b4d"}), s.html(t).fadeIn(200), setTimeout(function () {
            n.css({border: "1px solid #f1f0f0"}), o.css({border: "1px solid #f1f0f0"}), s.fadeOut("fast")
        }, e + 200))
    }

    tradeCart()
});